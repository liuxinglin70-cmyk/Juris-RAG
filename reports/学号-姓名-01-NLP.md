# [阶段性报告] 基于 RAG 的法律领域智能问答系统 (Juris-RAG)

## 0. 项目进展简述（Phase 2 中途状态）

- **当前状态**：端到端链路已跑通，RAG 引擎、向量库构建、Web UI 与评估脚本均可运行；界面已重构为 ChatGPT 风格布局，并修复了重复提交与 Gradio 版本兼容问题。
- **本次推进亮点**：
  - Web UI 重构：侧边栏模式切换（智能问答/文档搜索/系统信息），对话区+引用侧栏布局，交互更贴近真实使用场景。
  - 输入体验优化：支持 Enter 发送、Shift+Enter 换行，减少冗余点击。
  - 稳定性修复：修复对话重复记录、Gradio Chatbot 消息格式兼容问题。
  - 向量化节流：增加 RPM/TPM 限速与批处理节流，降低 API 速率限制失败率。
  - 样式拆分：新增 `assets/ui.css`，便于独立迭代前端样式。
- **已完成工作**：
  - 数据清洗与向量化（刑法法条 + CAIL 案例）。
  - ChromaDB 持久化向量库构建（`data/vector_db/`）。
  - RAG 核心引擎（多轮对话、引用与置信度输出）。
  - Gradio 前端与模式切换、引用展示、文档搜索。
  - 评估脚本 `eval.py` 的指标框架已具备。
- **待推进事项**：
  - 引入 rerank 模型与更精细的检索评估。
  - 扩展数据源（民法典、行政法等）。
  - 系统性评估与可视化报告输出。

---

## 一、项目概述

### 1.1 项目背景

在法律咨询场景中，普通用户难以理解晦涩的法条，而通用大模型（LLM）常出现编造法条（幻觉）的问题。本项目旨在构建 **Juris-RAG**，通过检索增强生成技术，结合《中华人民共和国刑法》与真实司法案例，提供准确、可解释的法律问答服务。

### 1.2 项目目标

- 构建支持长上下文、多轮对话的法律 RAG 系统。
- 在刑法场景降低幻觉，提高答案可信度。
- 回答必须携带引用来源，具备可追溯性。

### 1.3 技术选型

| 组件 | 选型 | 理由 |
| --- | --- | --- |
| LLM | Qwen2.5-7B-Instruct | 中文逻辑能力强，支持长文本 |
| Embedding | BAAI/bge-m3 | 中文语义检索性能优秀 |
| Vector DB | ChromaDB | 轻量、易部署、持久化 |
| Orchestration | LangChain | 多轮对话与检索链路成熟 |
| 前端 | Gradio | 快速搭建 UI，便于迭代 |

---

## 二、数据来源与处理

### 2.1 数据来源

- **刑法法条库**：中华人民共和国刑法（2020 修正）。
- **案例库**：CAIL 2018 公开数据集，默认使用 `cail_cases_20k.json`（约 20k 条）。

### 2.2 数据处理流程（ETL）

已实现自动化脚本 `src/data_processing.py`，流程如下：

1. **加载与清洗**：
   - 法条：按“条”分割文本。
   - 案例：提取 `fact` 作为检索文本，`meta` 作为引用元数据。
2. **分块策略**：
   - `chunk_size=500`, `chunk_overlap=100`。
   - 保留条文语义完整性，降低断章取义风险。
3. **向量化与持久化**：
   - BGE-M3 生成 1024 维向量。
   - 持久化写入 `data/vector_db/`。
4. **速率限制控制**：
   - 新增 RPM/TPM 节流参数与批处理控制，降低 API 限速失败。

---

## 三、方法与实现

### 3.1 系统架构

```
[用户输入]
   ↓
[历史对话重写器]
   ↓
[向量检索器（法条 + 案例）]
   ↓
[答案生成 + 引用整理]
   ↓
[输出：回答 + 引用 + 置信度]
```

### 3.2 关键实现要点

1. **多轮对话记忆**：通过历史感知检索链，让追问能够结合上下文检索。
2. **引用来源追踪**：引用展示文档来源、条款与元数据，增强可解释性。
3. **UI 重构**：新增侧边栏模式切换与引用侧栏，主聊天区更聚焦。
4. **兼容性处理**：针对 Gradio 6 的 Chatbot 消息格式变更做了兼容。

---

## 四、阶段性测试结果

### 4.1 CLI 功能验证

```
用户: 故意杀人罪怎么判刑？
助手: 根据《中华人民共和国刑法》第二百三十二条规定...（引用来源）

用户: 那如果是情节较轻的呢？
助手: 处三年以上十年以下有期徒刑...（引用来源）
```

### 4.2 Web UI 测试

当前 Web 端已支持：

- 智能问答与文档搜索两种模式。
- 引用来源与置信度侧栏展示。
- Enter 发送、Shift+Enter 换行。
- 修复重复提交与双条记录问题。

---

## 五、问题分析与解决

1. **API 速率限制**：
   - 问题：批量向量化时触发 RPM/TPM 限制。
   - 解决：新增节流与退避参数（`EMBED_RPM_LIMIT/TPM` 等），批处理控制。
2. **Gradio 版本差异**：
   - 问题：Chatbot 消息格式与主题参数在 Gradio 6 中变更。
   - 解决：加入消息格式转换与参数检测，保持兼容。
3. **对话重复提交**：
   - 问题：历史列表被引擎复用导致 UI 重复记录。
   - 解决：历史深拷贝与提交去重机制。

---

## 六、下一步计划

1. 引入 rerank 模型，提升检索精度与引用质量。
2. 扩展数据源（民法、行政法等），形成多领域法律库。
3. 输出完整评估报告并可视化指标趋势。
4. 进一步优化前端交互细节与可用性。
